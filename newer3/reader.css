/* =========================================================
   dukr3g reader.css  -  consolidated, namespaced, theme-aware
   ========================================================= */

/* -----------------------------
   Optional: 1-glyph fallback for 讀 (U+8B80)
   Host /fonts/duk-glyph.woff2 (subset from Noto/Source Han)
   ----------------------------- */
@font-face{
  font-family: "DukGlyph";
  src: url("/fonts/duk-glyph.woff2") format("woff2");
  font-display: swap;
  unicode-range: U+8B80; /* 讀 */
}

/* -----------------------------
   Base tokens
   ----------------------------- */
:root{
  /* Reading typography applied to .dukr3g-prose only */
  --dukr3g-scale:   1.00;
  --dukr3g-measure: 70;
  --dukr3g-leading: 1.60;
  --dukr3g-font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", sans-serif;

  /* Toolbar tokens with safe defaults */
  --dukr3g-surface:   #ffffff;
  --dukr3g-surface-2: #f4f6f8;
  --dukr3g-text:      #111111;
  --dukr3g-border:    #d7dde3;
  --dukr3g-accent:    #2b6cf0;
  --dukr3g-shadow:    0 8px 28px rgba(0,0,0,.20);
  --dukr3g-backdrop:  rgba(0,0,0,.40);

  /* Opener glyph metrics */
  --dukr3g-open-size: 20px;
  --dukr3g-open-nudge-x: 0px;
  --dukr3g-open-nudge-y: -1px;
  --dukr3g-fab-bg:    rgba(0,0,0,.55);
  --dukr3g-fab-fg:    #ffffff;

  /* Status pill */
  --dukr3g-status-bg: rgba(0,0,0,.60);
  --dukr3g-status-fg: #ffffff;

  /* User theme tokens. Used only when html.dukr3g-theme-custom is active. */
  --dukr3g-user-text: #111111;
  --dukr3g-user-bg: #ffffff;
  --dukr3g-user-link: #2b6cf0;
  --dukr3g-user-visited: #5a2bb0;

  /* Read-aloud highlight tokens */
  --dukr3g-ral-ink: #0064ff;       /* ink emphasis color */
  --dukr3g-ral-bg:  #ffec80;       /* background highlight color */
}

/* -----------------------------
   Document theme classes on <html>
   ----------------------------- */
.dukr3g-theme-light { color:#111; background:#fff; }
.dukr3g-theme-dark  { color:#eee; background:#111; }
.dukr3g-theme-sepia { color:#2b1d13; background:#f4ecd8; }
.dukr3g-theme-gray  { color:#111; background:#f2f2f2; }
.dukr3g-theme-high-contrast { color:#000; background:#fff; }
.dukr3g-theme-high-contrast a{ outline:2px solid currentColor; }

/* Per-theme overrides for toolbar tokens */
.dukr3g-theme-light{
  --dukr3g-surface:#ffffff; --dukr3g-surface-2:#f3f3f5; --dukr3g-text:#111111;
  --dukr3g-border:#d7dde3; --dukr3g-accent:#2b6cf0; --dukr3g-shadow:0 8px 28px rgba(0,0,0,.20);
  --dukr3g-backdrop:rgba(0,0,0,.40); --dukr3g-fab-bg:rgba(0,0,0,.55);
  --dukr3g-fab-fg:#ffffff; --dukr3g-status-bg:rgba(0,0,0,.65); --dukr3g-status-fg:#ffffff;
}
.dukr3g-theme-dark{
  --dukr3g-surface:#181a1f; --dukr3g-surface-2:#1f2228; --dukr3g-text:#eaecef;
  --dukr3g-border:#2b3036; --dukr3g-accent:#7fb2ff; --dukr3g-shadow:0 10px 30px rgba(0,0,0,.55);
  --dukr3g-backdrop:rgba(0,0,0,.55); --dukr3g-fab-bg:rgba(255,255,255,.22);
  --dukr3g-fab-fg:#ffffff; --dukr3g-status-bg:rgba(30,30,34,.85); --dukr3g-status-fg:#eaecef;
}
.dukr3g-theme-sepia{
  --dukr3g-surface:#fbf3e3; --dukr3g-surface-2:#efe6cf; --dukr3g-text:#2b1d13;
  --dukr3g-border:#dacfae; --dukr3g-accent:#8a5a20; --dukr3g-shadow:0 8px 26px rgba(60,40,20,.28);
  --dukr3g-backdrop:rgba(40,28,18,.45); --dukr3g-fab-bg:rgba(60,40,20,.55);
  --dukr3g-fab-fg:#fff8ee; --dukr3g-status-bg:rgba(60,40,20,.60); --dukr3g-status-fg:#fff8ee;
}
.dukr3g-theme-gray{
  --dukr3g-surface:#ffffff; --dukr3g-surface-2:#f1f1f1; --dukr3g-text:#111111;
  --dukr3g-border:#d0d0d0; --dukr3g-accent:#3b3b3b; --dukr3g-shadow:0 8px 28px rgba(0,0,0,.18);
  --dukr3g-backdrop:rgba(0,0,0,.35); --dukr3g-fab-bg:rgba(0,0,0,.55);
  --dukr3g-fab-fg:#ffffff; --dukr3g-status-bg:rgba(0,0,0,.55); --dukr3g-status-fg:#ffffff;
}
.dukr3g-theme-high-contrast{
  --dukr3g-surface:#ffffff; --dukr3g-surface-2:#ffffff; --dukr3g-text:#000000;
  --dukr3g-border:#000000; --dukr3g-accent:#000000; --dukr3g-shadow:none;
  --dukr3g-backdrop:rgba(0,0,0,.70); --dukr3g-fab-bg:#000000; --dukr3g-fab-fg:#ffffff;
  --dukr3g-status-bg:#000000; --dukr3g-status-fg:#ffffff;
}

/* Custom theme surface, used only when selected */
.dukr3g-theme-custom{
  color: var(--dukr3g-user-text, #111);
  background: var(--dukr3g-user-bg, #fff);

  /* Panel tokens follow the page for visual consistency */
  --dukr3g-surface:   var(--dukr3g-user-bg, #ffffff);
  --dukr3g-surface-2: color-mix(in srgb, var(--dukr3g-surface) 85%, black 15%);
  --dukr3g-text:      var(--dukr3g-user-text, #111111);
  --dukr3g-border:    color-mix(in srgb, var(--dukr3g-text) 20%, transparent);
  --dukr3g-accent:    var(--dukr3g-user-link, #2b6cf0);
  --dukr3g-status-bg: color-mix(in srgb, var(--dukr3g-text) 75%, transparent);
  --dukr3g-status-fg: var(--dukr3g-surface, #ffffff);
}

/* -----------------------------
   Reading content
   ----------------------------- */
.dukr3g-prose{
  font-family: var(--dukr3g-font);
  font-size: calc(16px * var(--dukr3g-scale));
  line-height: var(--dukr3g-leading);
  max-width: calc(var(--dukr3g-measure) * 1ch);
  margin: 2rem auto;
  padding: 0 1rem;
}

.dukr3g-prose a:link{
  color: var(--dukr3g-user-link, LinkText);
  text-decoration-thickness: .08em;
  text-underline-offset: .12em;
}
.dukr3g-prose a:visited{
  color: var(--dukr3g-user-visited, color-mix(in srgb, currentColor 60%, purple 40%));
}
.dukr3g-prose a:focus-visible{ outline: 2px solid var(--dukr3g-accent); outline-offset: 2px; }

/* Read-aloud ink emphasis: underline the current token or sentence */
.dukr3g-ral-ink{
  text-decoration-line: underline;
  text-decoration-thickness: .18em;
  text-underline-offset: .12em;
  text-decoration-color: var(--dukr3g-ral-ink);
  text-decoration-skip-ink: auto;
}

/* Read-aloud background highlight: high-visibility marker behind text */
.dukr3g-ral-bg{
  background: var(--dukr3g-ral-bg);
  box-decoration-break: clone;
  -webkit-box-decoration-break: clone;
}

/* Forced colors compatibility for reading content */
@media (forced-colors: active){
  .dukr3g-prose a:link,
  .dukr3g-prose a:visited{
    color: LinkText;
  }
  .dukr3g-ral-ink{ text-decoration-color: Highlight; }
  .dukr3g-ral-bg { background: Highlight; color: HighlightText; }
}

/* -----------------------------
   Opener button (uses 讀 glyph)
   ----------------------------- */
.dukr3g-open{
  position: fixed; top: 1rem; right: 1rem;
  width: 44px; height: 44px; z-index: 1000;
  border: 1px solid var(--dukr3g-border);
  border-radius: 10px;
  background: var(--dukr3g-fab-bg); color: var(--dukr3g-fab-fg);
  display: inline-flex; align-items: center; justify-content: center;
  cursor: pointer; padding: 0; min-height: 44px;
}
.dukr3g-open:focus-visible{ outline: 2px solid var(--dukr3g-accent); outline-offset: 2px; }

/* Guaranteed glyph first, then robust open CJK stack, then system */
.dukr3g-glyph{
  display: inline-block;
  font: 700 var(--dukr3g-open-size)/1
        "DukGlyph",
        "Noto Sans CJK SC","Noto Sans CJK TC","Source Han Sans",
        "PingFang SC","PingFang TC","Hiragino Sans GB",
        "Microsoft YaHei UI","Microsoft YaHei","Microsoft JhengHei UI","Microsoft JhengHei",
        "LXGW WenKai","IBM Plex Sans JP","M PLUS 1",
        system-ui, ui-sans-serif, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", sans-serif;
  transform: translate(var(--dukr3g-open-nudge-x), var(--dukr3g-open-nudge-y));
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
}

/* -----------------------------
   Dialog shell
   ----------------------------- */
#dukr3g-dialog{
  box-sizing: border-box;
  border: 1px solid var(--dukr3g-border);
  color: var(--dukr3g-text);
  background: var(--dukr3g-surface);
  border-radius: 12px; padding: 0;
  width: min(92vw, 760px);
  max-width: 100vw;
  max-height: min(92vh, 720px);
  box-shadow: var(--dukr3g-shadow);
}
#dukr3g-dialog::backdrop{ background: var(--dukr3g-backdrop); }

/* Header, sticky for hierarchy */
.dukr3g-panel-head{
  position: sticky; top: 0; z-index: 1;
  display: grid; grid-template-columns: 1fr auto; align-items: center;
  gap: .75rem; padding: .75rem 1rem;
  border-bottom: 1px solid var(--dukr3g-border);
  background: var(--dukr3g-surface);
}
@supports (background: color-mix(in srgb, black 10%, white 90%)){
  .dukr3g-panel-head{
    background: color-mix(in srgb, var(--dukr3g-surface) 86%, var(--dukr3g-text) 14%);
  }
}

/* -----------------------------
   Header actions
   ----------------------------- */
.dukr3g-head-actions{ display: inline-flex; gap: .5rem; }

/* Back and Close (text icons, WCAG >= 44px, identical look) */
#dukr3g-btn-back,
#dukr3g-btn-close{
  min-width: 44px;
  min-height: 44px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: .4rem;
  padding: .5rem .75rem;
  border: 1px solid var(--dukr3g-border);
  border-radius: 8px;
  background: var(--dukr3g-surface-2);
  color: var(--dukr3g-text);
  line-height: 1;
  font: 700 18px/1 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", sans-serif;
}
#dukr3g-btn-back:hover,
#dukr3g-btn-close:hover{
  background: color-mix(in srgb, var(--dukr3g-surface) 88%, var(--dukr3g-text) 12%);
  border-color: color-mix(in srgb, var(--dukr3g-text) 38%, transparent);
}
#dukr3g-btn-back:active,
#dukr3g-btn-close:active{
  background: color-mix(in srgb, var(--dukr3g-surface) 84%, var(--dukr3g-text) 16%);
  border-color: color-mix(in srgb, var(--dukr3g-text) 45%, transparent);
}
#dukr3g-btn-back:focus-visible,
#dukr3g-btn-close:focus-visible{
  outline: 2px solid var(--dukr3g-accent);
  outline-offset: 2px;
}
/* Icon-only variant (if you later remove the glyph text) */
#dukr3g-btn-back[data-icon],
#dukr3g-btn-close[data-icon]{ width: 44px; height: 44px; padding: 0; }

/* -----------------------------
   Body scroll container
   ----------------------------- */
.dukr3g-panel-body{
  padding: 1rem;
  display: grid; gap: 1rem;
  overflow: auto;
  overscroll-behavior: contain;
}

/* -----------------------------
   Views and navigation
   ----------------------------- */
.dukr3g-view-heading{ margin: 0 0 .25rem 0; font-size: 1.1rem; }
.dukr3g-view{ display: none; }
.dukr3g-current{ display: grid; }
#dukr3g-btn-back[hidden]{ display: none !important; }

/* -----------------------------
   Tile menu
   ----------------------------- */
.dukr3g-tile-grid{
  --min: 220px;
  display: grid; grid-template-columns: repeat(auto-fit, minmax(var(--min), 1fr));
  gap: 12px; list-style: none; margin: 0; padding: 0;
}
.dukr3g-tile{
  display: grid; align-content: start; gap: 6px;
  min-height: 112px;
  border-radius: 12px; padding: 1rem;
  color: inherit; cursor: pointer; text-align: left;
  background: var(--dukr3g-surface-2);
  border: 1px solid var(--dukr3g-border);
}
.dukr3g-tile:focus-visible{ outline: 2px solid var(--dukr3g-accent); outline-offset: 2px; }
.dukr3g-tile-title{ font: 600 1.1rem/1 ui-sans-serif, system-ui; }
.dukr3g-tile-desc{ opacity: .80; font-size: .95rem; }

/* -----------------------------
   Fieldsets and controls
   ----------------------------- */
fieldset{
  border: 1px solid var(--dukr3g-border);
  border-radius: 8px;
  padding: .85rem;
  background: var(--dukr3g-surface);
  min-inline-size: 0; /* avoid overflow with long labels */
}
legend{ padding: 0 .25rem; font-weight: 600; }

/* Control row:
   label | numeric/hex | range or color | output
   This fits both number+range and hex+color patterns. */
.dukr3g-control{
  display: grid;
  grid-template-columns: auto minmax(7ch, 12ch) 1fr auto;
  align-items: center;
  column-gap: 1rem;           /* space so number and slider do not crowd */
  row-gap: .4rem;
}
.dukr3g-control > label{
  font-weight: 600;
  line-height: 1.2;
  white-space: nowrap;
}

/* Number boxes */
.dukr3g-control input[type="number"]{
  padding: .45rem .5rem;
  border: 1px solid var(--dukr3g-border);
  border-radius: 6px;
  background: var(--dukr3g-surface);
  color: var(--dukr3g-text);
  font: 0.95rem/1.2 ui-sans-serif, system-ui;
  width: 100%;
  min-height: 44px;
}

/* Range sliders */
.dukr3g-control input[type="range"]{
  width: 100%;
  min-height: calc(44px - 10px);
  margin-inline-start: .25rem;  /* breathing room beside the number */
}

/* Hex text boxes */
.dukr3g-control input[type="text"]{
  padding: .45rem .5rem;
  border: 1px solid var(--dukr3g-border);
  border-radius: 6px;
  background: var(--dukr3g-surface);
  color: var(--dukr3g-text);
  font: 500 0.95rem/1.2 ui-monospace, "SFMono-Regular", Menlo, Consolas, "Liberation Mono", monospace;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  width: 100%;
  min-height: 44px;
}
.dukr3g-control input[type="text"]::placeholder{ color: #8892a2; }
.dukr3g-control input[type="text"]:invalid{ border-color: #c05621; }

/* Color windows */
.dukr3g-control input[type="color"]{
  width: 3rem;
  height: 44px;
  padding: 0;
  border: 1px solid var(--dukr3g-border);
  border-radius: 6px;
  background: var(--dukr3g-surface);
  inline-size: 3rem;
  block-size: 44px;
  justify-self: start;
  margin-inline-start: .25rem;
}

/* Output cells */
.dukr3g-control output{
  min-width: 7ch;
  text-align: right;
  font-variant-numeric: tabular-nums;
  font: 600 0.95rem/1.2 ui-monospace, "SFMono-Regular", Menlo, Consolas, "Liberation Mono", monospace;
}

/* Wider screens: nudge the number–slider gap a hair more */
@media (min-width: 1024px){
  .dukr3g-control{ column-gap: 1.15rem; }
  .dukr3g-control input[type="range"]{ margin-inline-start: .35rem; }
}

/* Stack controls on small screens */
@media (max-width: 520px){
  .dukr3g-control{ grid-template-columns: 1fr; }
  .dukr3g-control > label{ margin-bottom: .15rem; }
  .dukr3g-control input[type="range"]{ margin-inline-start: 0; }
  .dukr3g-control output{ justify-self: end; }
}
@media (max-width: 380px){
  .dukr3g-control input[type="number"],
  .dukr3g-control input[type="text"]{ min-width: 12ch; }
  .dukr3g-control input[type="range"]{ margin-block: .15rem; }
}

/* -----------------------------
   TTS transport buttons
   ----------------------------- */
.dukr3g-tts-playback button{
  min-width: 44px; min-height: 44px;
  padding: .5rem .75rem;
  border: 1px solid var(--dukr3g-border);
  border-radius: 8px;
  background: var(--dukr3g-surface-2);
  color: var(--dukr3g-text);
}

/* -----------------------------
   Live status pill
   ----------------------------- */
.dukr3g-status{
  position: fixed; bottom: .5rem; left: 50%; transform: translateX(-50%);
  padding: .25rem .5rem; border-radius: 6px;
  background: var(--dukr3g-status-bg); color: var(--dukr3g-status-fg);
  font: 0.95rem/1.2 ui-sans-serif, system-ui; pointer-events: none;
}

/* -----------------------------
   High contrast adaptations
   ----------------------------- */
.dukr3g-theme-high-contrast .dukr3g-tile-grid{ grid-template-columns: 1fr; }
.dukr3g-theme-high-contrast .dukr3g-tile-desc{ opacity: 1; }
.dukr3g-theme-high-contrast .dukr3g-panel-head{ background: #fff; }

/* -----------------------------
   Forced colors compliance
   ----------------------------- */
@media (forced-colors: active){
  #dukr3g-dialog, .dukr3g-tile, fieldset, .dukr3g-open,
  .dukr3g-control input[type="number"], .dukr3g-control input[type="range"],
  .dukr3g-control input[type="text"], .dukr3g-control input[type="color"],
  .dukr3g-tts-playback button,
  #dukr3g-btn-back, #dukr3g-btn-close{
    forced-color-adjust: none;
    background: Canvas;
    color: CanvasText;
    border: 1px solid CanvasText;
  }
  #dukr3g-dialog::backdrop{ background: rgba(0,0,0,.7); }
  .dukr3g-open{ background: ButtonFace; color: ButtonText; }
  .dukr3g-status{ background: CanvasText; color: Canvas; }
}

/* -----------------------------
   Visually hidden utility
   ----------------------------- */
.dukr3g-visually-hidden{
  position: absolute !important;
  width: 1px; height: 1px;
  padding: 0; margin: -1px;
  overflow: hidden; clip: rect(0,0,0,0);
  white-space: nowrap; border: 0;
}

/* -----------------------------
   Reduced motion
   ----------------------------- */
@media (prefers-reduced-motion: reduce){
  *{ transition-duration: 0.001ms !important; animation-duration: 0.001ms !important; }
}

.dukr3g-w{ transition: background-color .12s linear, text-decoration-color .12s linear; }
